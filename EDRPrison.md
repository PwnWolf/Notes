```
https://www.3nailsinfosec.com/post/edrprison-borrow-a-legitimate-driver-to-mute-edr-agent
```
# 介绍
借用合法驱动程序将EDR代理静音，该方法不同于典型的规避方法，如睡眠混淆、堆栈混淆或系统调用，相反，他利用了检测机制中的疏忽。
# 基于网络连接的规避
除了使用高级恶意软件直接与EDR进行对抗，还有其他方式可以实现规避，如利用EDR的错误配置或漏洞、卸载EDR代理或使用自带易受攻击的驱动程序（BYOVD）来终止EDR进程。基于网络连接的规避是其中之一
这个概念并不是全新的，EDR代理通过发送遥测数据（包括主机信息、诊断警报、检测和其他数据）定期与中央服务器或云服务器通信。对于更复杂的恶意软件，EDR代理坑不会立即终止它，相反，代理会监控任意软件的行为并利用云上的机器学习。一旦收集到足够的数据，恶意软件的执行将会被终止，这表明EDR将会较为依赖云。当然，代理任然可以检测经典的恶意软件和技术，如普通的mimikatz，但是如果没有网络连接的话，EDR就会失去大部分活性，并且安全管理团队无法通过EDR管理面板控制端点。
## 本地测试
在测试机器上安装Defender for Business和Elastic Endpoint，并执行了一些恶意程序，通过流量抓包分析能够确定这些数据包中包含了检测信息和警报信息
这里我们就需要考虑，除了遇到互联网中断或停电之外还有哪些手段能够使得端点离线。我们可以通过设置规则来防止EDR进程将数据发送到云服务器上，然而除了需要管理员权限之外，还有其他缺点和缓解措施。比如启启用篡改保护，将阻止利用防火墙规则使MDE进程静音的尝试。景观篡改保护专门保护MDE进程，但是对其他EDR也可以采用类似的保护机制。禁用防火墙规则合并是另一种有效的对策， 特别是使用ADd组织，组策略（GPO）可以替代终结点本地防火墙设置
Windows Defender 防火墙支持基于远程地址和端口的规则。不幸的是，一些 EDR 产品与数百甚至数千个联系人服务器进行通信，因此很难在保持隐蔽性的同时包含每个联系人服务器。对于 Microsoft Defender for Endpoint/Business，我们可以参考有关配置设备连接  和 Azure IP 范围的文档 。数据可以在数千台云服务器之间发送到云端，这种复杂性适用于单个 EDR，更不用说其他 EDR 产品了。
直接篡改widnows defender防火墙很容易被发现，因此在低权限进行篡改可以更好的实现，windows过滤平台（WTP）是一个好选择
根据 Microsoft 文档 ，WFP 是一组 API 和系统服务，为开发人员提供了与不同层的数据包处理交互和作数据包处理的灵活性和能力。WFP 允许用户按应用程序、用户、地址、网络接口等过滤连接。WFP 的功能用于内容过滤、家长控制、审查规避、深度数据包检查等。因此，WFP 被 IDS/IPS、广告拦截器、防火墙、EDR 和 VPN 等安全产品广泛使用。Windows Defender 防火墙也基于 WFP。以下屏幕截图显示 AdGuard 使用 WFP 驱动程序来扩展其功能。
WTP重要参数介绍
Callouts  标注
标注是由驱动程序公开的一组函数，用于专用筛选。WFP 包括一些内置标注函数 ，每个函数都由 GUID 标识。
Filter Engine  过滤器引擎
筛选器引擎由用户模式组件（基本筛选引擎 （BFE）和内核模式组件（泛型筛选器引擎）组成。这些组件协同工作，对数据包执行过滤作。内核模式组件在网络层和传输层执行筛选。在将筛选器应用于网络流量的过程中，内核模式组件调用可用的标注函数。
Filters  过滤 器
过滤器是与数据包匹配的规则，告诉过滤器引擎如何处理流量。例如，规则可以是“阻止所有到 TCP 端口 9200 的出站数据包”。筛选器可以是启动时或运行时。启动时筛选器在启动期间启动时强制执行 tcpip.sys 而运行时筛选器更灵活。
Callout Driver  标注驱动程序
为了实现更具体的目标，如DPI或网站家长控制，需要一个自定义调出驱动程序来扩展WFP的功能。Microsoft提供了一个示例WFP调出驱动程序项目，可以在此处找到。WFPSampler.exe使用示例调出驱动程序来定义策略，如下所述。
有了 WFPExplorer，我们查看标注、WFP 提供程序、图层、过滤器、网络事件等变得更加方便。从屏幕截图中我们可以看到，许多安全产品和内置应用程序都使用 WFP。